var oe=o=>{throw TypeError(o)};var ne=(o,e,t)=>e.has(o)||oe("Cannot "+t);var r=(o,e,t)=>(ne(o,e,"read from private field"),t?t.call(o):e.get(o)),u=(o,e,t)=>e.has(o)?oe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),h=(o,e,t,s)=>(ne(o,e,"write to private field"),s?s.call(o,t):e.set(o,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const me=o=>`
  <article class="story-item">
    <img src="${o.photoUrl}" alt="${o.description}" class="story-item__thumbnail" loading="lazy">
    <div class="story-item__content">
      <h3 class="story-item__name">${o.name}</h3>
      <p class="story-item__description">${o.description}</p>
      <p class="story-item__date">${new Date(o.createdAt).toLocaleDateString()}</p>
      ${o.lat&&o.lon?`
        <button class="story-item__view-on-map" data-lat="${o.lat}" data-lon="${o.lon}" onclick="window.location.hash = '#/detail/:${o.id}'">Lihat di Peta</button>
      `:""}
    </div>
  </article>
`;var y,x,A;class ge{constructor({view:e,storyModel:t,authModel:s}){u(this,y);u(this,x);u(this,A);h(this,y,e),h(this,x,t),h(this,A,s)}async initialize(){r(this,y).bindLogoutButton(this._handleLogout.bind(this)),await this._loadStories(),r(this,y).focusMainContent(),r(this,y).handleSkipLinkAutoFocus()}_handleLogout(e){e.preventDefault(),r(this,A).clearAuthData(),window.location.hash="#/login"}async _loadStories(){const e=localStorage.getItem("authToken");if(!e){r(this,y).displayLoginPrompt();return}try{const t=await r(this,x).getAllStories(e,1,10,0);t.success?r(this,y).renderStories(t.data):(console.error("Error fetching stories:",t.error),r(this,y).displayErrorMessage(t.error))}catch(t){console.error("Failed to fetch stories:",t),r(this,y).displayErrorMessage("Terjadi kesalahan saat mengambil data cerita.")}}}y=new WeakMap,x=new WeakMap,A=new WeakMap;const z="https://story-api.dicoding.dev/v1",H={REGISTER:`${z}/register`,LOGIN:`${z}/login`,ADD_STORY:`${z}/stories`,GET_ALL_STORIES:`${z}/stories`},Z=(o,e)=>e.some(t=>o instanceof t);let re,ie;function pe(){return re||(re=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ye(){return ie||(ie=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Q=new WeakMap,K=new WeakMap,q=new WeakMap;function fe(o){const e=new Promise((t,s)=>{const n=()=>{o.removeEventListener("success",i),o.removeEventListener("error",a)},i=()=>{t(P(o.result)),n()},a=()=>{s(o.error),n()};o.addEventListener("success",i),o.addEventListener("error",a)});return q.set(e,o),e}function we(o){if(Q.has(o))return;const e=new Promise((t,s)=>{const n=()=>{o.removeEventListener("complete",i),o.removeEventListener("error",a),o.removeEventListener("abort",a)},i=()=>{t(),n()},a=()=>{s(o.error||new DOMException("AbortError","AbortError")),n()};o.addEventListener("complete",i),o.addEventListener("error",a),o.addEventListener("abort",a)});Q.set(o,e)}let X={get(o,e,t){if(o instanceof IDBTransaction){if(e==="done")return Q.get(o);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return P(o[e])},set(o,e,t){return o[e]=t,!0},has(o,e){return o instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in o}};function de(o){X=o(X)}function be(o){return ye().includes(o)?function(...e){return o.apply(ee(this),e),P(this.request)}:function(...e){return P(o.apply(ee(this),e))}}function ve(o){return typeof o=="function"?be(o):(o instanceof IDBTransaction&&we(o),Z(o,pe())?new Proxy(o,X):o)}function P(o){if(o instanceof IDBRequest)return fe(o);if(K.has(o))return K.get(o);const e=ve(o);return e!==o&&(K.set(o,e),q.set(e,o)),e}const ee=o=>q.get(o);function ke(o,e,{blocked:t,upgrade:s,blocking:n,terminated:i}={}){const a=indexedDB.open(o,e),c=P(a);return s&&a.addEventListener("upgradeneeded",l=>{s(P(a.result),l.oldVersion,l.newVersion,P(a.transaction),l)}),t&&a.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),c.then(l=>{i&&l.addEventListener("close",()=>i()),n&&l.addEventListener("versionchange",m=>n(m.oldVersion,m.newVersion,m))}).catch(()=>{}),c}const Ee=["get","getKey","getAll","getAllKeys","count"],Ie=["put","add","delete","clear"],J=new Map;function ae(o,e){if(!(o instanceof IDBDatabase&&!(e in o)&&typeof e=="string"))return;if(J.get(e))return J.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,n=Ie.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(n||Ee.includes(t)))return;const i=async function(a,...c){const l=this.transaction(a,n?"readwrite":"readonly");let m=l.store;return s&&(m=m.index(c.shift())),(await Promise.all([m[t](...c),n&&l.done]))[0]};return J.set(e,i),i}de(o=>({...o,get:(e,t,s)=>ae(e,t)||o.get(e,t,s),has:(e,t)=>!!ae(e,t)||o.has(e,t)}));const Se=["continue","continuePrimaryKey","advance"],ce={},te=new WeakMap,ue=new WeakMap,Be={get(o,e){if(!Se.includes(e))return o[e];let t=ce[e];return t||(t=ce[e]=function(...s){te.set(this,ue.get(this)[e](...s))}),t}};async function*Le(...o){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...o)),!e)return;e=e;const t=new Proxy(e,Be);for(ue.set(t,e),q.set(t,ee(e));e;)yield t,e=await(te.get(t)||e.continue()),te.delete(t)}function le(o,e){return e===Symbol.asyncIterator&&Z(o,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&Z(o,[IDBIndex,IDBObjectStore])}de(o=>({...o,get(e,t,s){return le(e,t)?Le:o.get(e,t,s)},has(e,t){return le(e,t)||o.has(e,t)}}));const Pe="story-app-db",Me=1,k="stories",M={async open(){return ke(Pe,Me,{upgrade(o){o.objectStoreNames.contains(k)||o.createObjectStore(k,{keyPath:"id"})}})},async getStoryDetail(o){return(await this.open()).get(k,o)},async getAllStories(){return(await this.open()).getAll(k)},async putStories(o){const t=(await this.open()).transaction(k,"readwrite"),s=t.objectStore(k);return await Promise.all(o.map(n=>s.put(n))),t.done},async clearStories(){const e=(await this.open()).transaction(k,"readwrite");return await e.objectStore(k).clear(),e.done}};class Ce{constructor(e=H.GET_ALL_STORIES||"https://story-api.dicoding.dev/v1/stories"){this.baseUrl=e}async getAllStories(e,t=1,s=10,n=0){try{const i=await fetch(`${this.baseUrl}?page=${t}&size=${s}&location=${n}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),a=await i.json();if(!i.ok){console.warn("Network fetch failed, attempting to get from IndexedDB.");const c=await M.getAllStories();if(c&&c.length>0)return{success:!0,data:c,error:null,source:"indexeddb_fallback"};throw new Error(a.message||"Failed to fetch stories from network or cache.")}return await M.putStories(a.listStory),{success:!0,data:a.listStory,error:null,source:"network"}}catch(i){console.error("Error fetching stories:",i),console.warn("Network request failed, trying to retrieve from IndexedDB.");try{const a=await M.getAllStories();return a&&a.length>0?{success:!0,data:a,error:null,source:"indexeddb"}:{success:!1,data:null,error:i.message||"An error occurred and no cached data available.",source:"no_data_available"}}catch(a){return console.error("Error retrieving from IndexedDB:",a),{success:!1,data:null,error:`Network error and IndexedDB retrieval failed: ${i.message||a.message}`,source:"fetch_and_indexeddb_failed"}}}}}class v{constructor(e=H.LOGIN){this.baseUrl=e}async _clearServiceWorkerCaches(){return"serviceWorker"in navigator&&navigator.serviceWorker.controller?(console.log("Mengirim pesan ke service worker untuk membersihkan cache..."),new Promise((e,t)=>{const s=new MessageChannel;s.port1.onmessage=n=>{n.data.status==="success"?(console.log("Cache service worker berhasil dikosongkan."),e()):(console.error("Gagal mengosongkan cache service worker:",n.data.error),t(new Error(n.data.error)))},navigator.serviceWorker.controller.postMessage({action:"clearAllCaches"},[s.port2])})):(console.warn("Service Worker tidak terdaftar atau tidak aktif. Tidak dapat membersihkan cache."),Promise.resolve())}async _clearAllIndexedDBData(){console.log("Membersihkan semua data di IndexedDB...");try{await M.clearStories(),console.log("Semua data IndexedDB (stories dan detail-stories) berhasil dikosongkan.")}catch(e){throw console.error("Gagal membersihkan data IndexedDB:",e),e}}async login(e,t){try{const s=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),n=await s.json();if(!s.ok)throw new Error(n.message||"Login failed");return{success:!0,data:{message:n.message,userId:n.loginResult.userId,name:n.loginResult.name,token:n.loginResult.token},error:null}}catch(s){return{success:!1,data:null,error:s.message||"An error occurred during login"}}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static storeAuthData(e,t,s){localStorage.setItem("authToken",e),localStorage.setItem("userId",t),localStorage.setItem("userName",s)}static isAuthenticated(){return!!localStorage.getItem("authToken")}static async clearAuthData(){localStorage.removeItem("authToken"),localStorage.removeItem("userId"),localStorage.removeItem("userName");const e=new v;await e._clearAllIndexedDBData(),await e._clearServiceWorkerCaches()}}var F;class De{constructor(){u(this,F)}getTemplate(){return`
      <a href="#mainContent" class="skip-link">Skip to main content</a>
      <header>
        <div class="header-content">
          <a href="#/login" id="logoutBtn" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Logout
          </a>
          <div id="userInfo"></div>
        </div>
      </header>
      <main id='asep3' tabindex="-1"> <h1>Story List</h1>
        <h2>Bagikan Ceritamu!</h2>
        <p>Temukan cerita menarik dari pengguna Dicoding.</p>
        <a id="tambahBtn" href="#/add">Tambah Cerita</a>
        <div id="story-container"></div>
      </main>
    `}getElements(){return{logoutBtn:document.getElementById("logoutBtn"),storyContainer:document.getElementById("story-container"),userInfoDiv:document.getElementById("userInfo"),mainContent:document.querySelector("#story-container"),skipLink:document.querySelector(".skip-link")}}bindLogoutButton(e){const{logoutBtn:t}=this.getElements();t&&t.addEventListener("click",e)}renderStories(e){const{storyContainer:t}=this.getElements();t&&(t.innerHTML="",e.forEach(s=>{const n=document.createElement("div");n.classList.add("story"),n.innerHTML+=me(s),t.appendChild(n)}))}handleSkipLinkAutoFocus(){const{skipLink:e}=this.getElements();if(!e)return;function t(){window.scrollY===0?(e.style.top="80px",e.style.left="50px",e.tabIndex=0,e.focus()):(e.style.top="-100px",e.tabIndex=-1,e.blur())}window.addEventListener("scroll",t),window.addEventListener("load",t)}displayLoginPrompt(){const{storyContainer:e}=this.getElements();e&&(e.innerHTML='<p>Anda harus <a href="#/login">login</a> terlebih dahulu untuk melihat daftar cerita.</p>')}displayErrorMessage(e){const{storyContainer:t}=this.getElements();t&&(t.innerHTML=`<p>Error: ${e}</p>`)}focusMainContent(){const{mainContent:e,skipLink:t}=this.getElements();!e||!t||t._focusHandlerAdded||(t.addEventListener("click",function(s){s.preventDefault(),t.blur();const n=e.querySelector(".story-item__view-on-map");n?n.focus():e.focus(),e.scrollIntoView()}),t._focusHandlerAdded=!0)}async render(){return this.getTemplate()}async afterRender(){const e=new Ce,t=v;h(this,F,new ge({view:this,storyModel:e,authModel:t})),await r(this,F).initialize()}}F=new WeakMap;var d,I,G,C;class _e{constructor({view:e,addStoryModel:t,authModel:s=v}){u(this,d);u(this,I);u(this,G);u(this,C);h(this,d,e),h(this,I,t),h(this,G,s),h(this,C,localStorage.getItem("authToken")),this._stream=null,this._map=null,this._marker=null}async initialize(){if(!r(this,C)){r(this,d).displayMessage("You need to login first to share a story","error"),r(this,d).hideForm(),setTimeout(()=>window.location.href="#/login",2e3);return}const{map:e,marker:t}=r(this,d).initMap(this._handleMapClick.bind(this),this._handleLatLonInputChange.bind(this));this._map=e,this._marker=t,r(this,d).bindFormSubmit(this._handleSubmitStory.bind(this)),r(this,d).bindStartCameraButton(this._handleStartCamera.bind(this)),r(this,d).bindCaptureButton(this._handleCapturePhoto.bind(this)),r(this,d).bindPhotoInputChange(this._handlePhotoInputChange.bind(this)),r(this,d).bindLocationInputChanges(()=>this._handleLatLonInputChange(r(this,d).getElements().latInput,r(this,d).getElements().lonInput,this._marker,this._map),()=>this._handleLatLonInputChange(r(this,d).getElements().latInput,r(this,d).getElements().lonInput,this._marker,this._map))}_handleMapClick(e,t,s,n){this._marker=r(this,d).updateMapMarker(e,t,s,n)}_handleLatLonInputChange(e,t,s,n){const i=parseFloat(e.value),a=parseFloat(t.value);isNaN(i)||isNaN(a)||(this._marker=r(this,d).updateMapMarker(i,a,s,n),n&&n.setView([i,a],n.getZoom()))}async _handleStartCamera(){try{this._stream=await navigator.mediaDevices.getUserMedia({video:!0}),r(this,d).showCameraPreview(this._stream)}catch(e){alert("Unable to access camera: "+e.message)}}_handleCapturePhoto(){if(!this._stream)return;const{snapshotCanvas:e,cameraPreview:t,photoInput:s}=r(this,d).getElements(),n=e.getContext("2d");e.width=t.videoWidth,e.height=t.videoHeight,n.drawImage(t,0,0,e.width,e.height),e.toBlob(i=>{const a=new File([i],"captured.jpeg",{type:"image/jpeg"}),c=new DataTransfer;c.items.add(a),s.files=c.files;const l=URL.createObjectURL(a);r(this,d).displayPhotoPreview(l),this._stream&&(this._stream.getTracks().forEach(m=>m.stop()),this._stream=null),r(this,d).hideCameraPreview()},"image/jpeg",.95)}_handlePhotoInputChange(e){const t=e.target.files[0];if(t&&t.type.startsWith("image/")){const s=URL.createObjectURL(t);r(this,d).displayPhotoPreview(s)}}async _handleSubmitStory(e){e.preventDefault(),r(this,d).hideMessage(),r(this,d).disableSubmitButton(!0);const{descriptionInput:t,photoInput:s,latInput:n,lonInput:i}=r(this,d).getElements(),a=s.files[0];if(typeof r(this,I).isValidImage!="function"||!r(this,I).isValidImage(a)){r(this,d).displayMessage("Please upload a valid image (JPEG/PNG/GIF, max 1MB)","error"),r(this,d).disableSubmitButton(!1);return}const c=new FormData;c.append("description",t.value),c.append("photo",a),n.value&&i.value&&(c.append("lat",parseFloat(n.value)),c.append("lon",parseFloat(i.value)));try{const l=await new(r(this,I))().submitStory(c,r(this,C));l.success?(r(this,d).displayMessage("Story submitted successfully!","success"),r(this,d).resetForm(),window.location.href="#/"):r(this,d).displayMessage(l.error||"Failed to submit story","error")}catch(l){r(this,d).displayMessage("An error occurred. Please try again.","error"),console.error(l)}finally{r(this,d).disableSubmitButton(!1)}}}d=new WeakMap,I=new WeakMap,G=new WeakMap,C=new WeakMap;class Te{constructor(e=H.ADD_STORY||"https://story-api.dicoding.dev/v1/stories"){this.baseUrl=e}async submitStory(e,t){try{const s=await fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e}),n=await s.text();console.log("Raw response text:",n);const i=JSON.parse(n);if(s.status!==201)throw new Error(i.message||"Failed to submit story");if(s.status===201)return{success:!0,data:i,error:null}}catch(s){return{success:!1,data:null,error:s.message||"An error occurred while submitting the story"}}}static isValidImage(e){if(!e)return!1;const t=["image/jpeg","image/png","image/gif"],s=1*1024*1024;return t.includes(e.type)&&e.size<=s}}var N;class xe{constructor(){u(this,N)}getTemplate(){return`
      <header>
        <div class="header-content">
          <a href="#/" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Stories
          </a>
          <div id="userInfo"></div>
        </div>
      </header>

      <main id="alien" class="story-container">
        <h1>Share Your Story</h1>
        <form id="storyForm" enctype="multipart/form-data">
          <section class="form-group">
            <label for="description">Story Description</label>
            <textarea id="description" name="description" rows="4" required></textarea>
          </section>

          <section class="form-group">
            <label>Take a Photo or Upload</label>
            <div class="camera-section">
              <video id="cameraPreview" autoplay playsinline style="display: none; width: 100%; max-height: 250px;"></video>
              <button type="button" id="startCameraBtn" class="captureBtn">Start Camera</button>
              <button type="button" id="captureBtn" class="captureBtn">Capture</button>
              <canvas id="snapshotCanvas" style="display: none;"></canvas>
            </div>

            <div id="asep2" class="form-group">
              <label for="photo">Or Upload Photo (Max 1MB)</label>
              <input type="file" id="photo" name="photo" accept="image/*">
              <div class="file-hint">Accepted formats: JPEG, PNG, GIF</div>
              <img id="photo-preview" style="max-width: 100%; margin-top: 10px; display: none;" />
            </div>
          </section>

          <section class="location-group">
            <h3>Location (Optional)</h3>
            <div class="form-row">
              <div class="form-group half-width">
                <label for="lat">Latitude</label>
                <input type="number" id="lat" name="lat" step="any" placeholder="e.g., -6.2088">
              </div>
              <div class="form-group half-width">
                <label for="lon">Longitude</label>
                <input type="number" id="lon" name="lon" step="any" placeholder="e.g., 106.8456">
              </div>
            </div>
            <div class="map-container" style="margin-top: 10px; margin-bottom: 10px; margin-right: 10px; margin-left: 10px;">
              <div id="map-picker"></div>
            </div>
          </section>

          <button type="submit" id="submitBtn">Submit Story</button>
        </form>

        <section id="message" class="message"></section>
      </main>
    `}getElements(){return{storyForm:document.getElementById("storyForm"),descriptionInput:document.getElementById("description"),photoInput:document.getElementById("photo"),latInput:document.getElementById("lat"),lonInput:document.getElementById("lon"),messageDiv:document.getElementById("message"),submitBtn:document.getElementById("submitBtn"),mapPicker:document.getElementById("map-picker"),cameraPreview:document.getElementById("cameraPreview"),startCameraBtn:document.getElementById("startCameraBtn"),captureBtn:document.getElementById("captureBtn"),snapshotCanvas:document.getElementById("snapshotCanvas"),photoPreview:document.getElementById("photo-preview")}}bindFormSubmit(e){const{storyForm:t}=this.getElements();t&&t.addEventListener("submit",e)}bindStartCameraButton(e){const{startCameraBtn:t}=this.getElements();t&&t.addEventListener("click",e)}bindCaptureButton(e){const{captureBtn:t}=this.getElements();t&&t.addEventListener("click",e)}bindPhotoInputChange(e){const{photoInput:t}=this.getElements();t&&t.addEventListener("change",e)}bindLocationInputChanges(e,t){const{latInput:s,lonInput:n}=this.getElements();s&&s.addEventListener("change",e),n&&n.addEventListener("change",t)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessage(){const{messageDiv:e}=this.getElements();e&&(e.style.display="none")}disableSubmitButton(e){const{submitBtn:t}=this.getElements();t&&(t.disabled=e,t.textContent=e?"Submitting...":"Submit Story")}hideForm(){const{storyForm:e}=this.getElements();e&&(e.style.display="none")}showCameraPreview(e){const{cameraPreview:t,captureBtn:s}=this.getElements();t&&(t.srcObject=e,t.style.display=""),s&&(s.disabled=!1)}hideCameraPreview(){const{cameraPreview:e,captureBtn:t}=this.getElements();e&&(e.srcObject=null,e.style.display="none"),t&&(t.disabled=!0)}displayPhotoPreview(e){const{photoPreview:t}=this.getElements();t&&(t.src=e,t.style.display="block")}hidePhotoPreview(){const{photoPreview:e}=this.getElements();e&&(e.src="",e.style.display="none")}resetForm(){const{storyForm:e}=this.getElements();e&&e.reset(),this.hidePhotoPreview(),this.hideCameraPreview()}initMap(e,t){const{mapPicker:s,latInput:n,lonInput:i}=this.getElements();let a,c;if(window.L&&s){s.style.width="100%",s.style.height="400px",s.style.position="relative";const l=[-7.12,110.4225];a=L.map("map-picker",{zoom:12,center:l}),window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',minZoom:5,maxZoom:10}).addTo(a),"geolocation"in navigator||console.error("Geolocation tidak didukung oleh browser ini."),c=L.marker(l),navigator.geolocation.getCurrentPosition(m=>{const{latitude:w,longitude:b}=m.coords;console.log(`Latitude: ${w}, Longitude: ${b}`),a.setView([w,b],15),this.updateMapMarker(w,b,c,a),n.value=w.toFixed(5),i.value=b.toFixed(5)},m=>{console.error("Error getting current position:",m),c.addTo(a),c.bindPopup("Default Location (Semarang)").openPopup()}),a.on("click",m=>{const{lat:w,lng:b}=m.latlng;n.value=w.toFixed(5),i.value=b.toFixed(5),e(w,b,c,a)}),t(n,i,c,a)}return{map:a,marker:c}}updateMapMarker(e,t,s,n){const i=[e,t];return s?s.setLatLng(i):s=window.L.marker(i),s.addTo(n),s.bindPopup(`Latitude: ${e}, Longitude: ${t}`).openPopup(),s}async render(){return this.getTemplate()}async afterRender(){h(this,N,new _e({view:this,addStoryModel:Te,authModel:v})),await r(this,N).initialize()}}N=new WeakMap;var p,R,W,U;class Ae{constructor({view:e,detailStoryModel:t,authModel:s=v,urlParser:n}){u(this,p);u(this,R);u(this,W);u(this,U);h(this,p,e),h(this,R,t),h(this,W,s),h(this,U,n)}async initialize(){r(this,p).bindBackButton(this._handleBackButtonClick.bind(this)),await this._loadStoryDetail()}_handleBackButtonClick(e){e.preventDefault(),window.history.back()}async _loadStoryDetail(){const e=window.location.href,t=r(this,U).call(this,e);console.log("DEBUG: Story ID =",t);const s=localStorage.getItem("authToken");if(!s){r(this,p).showError("Please login first"),setTimeout(()=>window.location.href="#/login",2e3);return}r(this,p).showLoading();try{const n=await r(this,R).getStoryDetail(s,t);setTimeout(()=>{r(this,p).hideLoading(),n.success?r(this,p).displayStory(n.data):r(this,p).showError(n.error||"Failed to load story details.")},500)}catch(n){console.error("Error fetching story detail:",n),r(this,p).hideLoading(),r(this,p).showError("An unexpected error occurred while fetching story details.")}}}p=new WeakMap,R=new WeakMap,W=new WeakMap,U=new WeakMap;class Fe{constructor(e="https://story-api.dicoding.dev/v1"){this.baseUrl=e}async getStoryDetail(e,t){try{const s=await fetch(`${this.baseUrl}/stories/${t}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),n=await s.json();if(!s.ok){console.warn("Network fetch for story detail failed, attempting to get from IndexedDB.");const i=await M.getStoryDetail(t);if(i)return{success:!0,data:i,error:null,source:"indexeddb_fallback"};throw new Error(n.message||"Failed to fetch story detail from network or cache.")}return{success:!0,data:n.story,error:null,source:"network"}}catch(s){console.error("Error fetching story detail:",s),console.warn("Network request for story detail failed, trying to retrieve from IndexedDB.");try{const n=await M.getStoryDetail(t);return n?{success:!0,data:n,error:null,source:"indexeddb"}:{success:!1,data:null,error:s.message||"An error occurred and no cached detail data available.",source:"no_detail_data_available"}}catch(n){return console.error("Error retrieving from IndexedDB for story detail:",n),{success:!1,data:null,error:`Network error and IndexedDB retrieval failed for detail: ${s.message||n.message}`,source:"fetch_and_indexeddb_detail_failed"}}}}}function Ne(o){const e=o.split("/");return{resource:e[1]||null,id:e[2]||null}}function Re(o){let e="";return o.resource&&(e=e.concat(`/${o.resource}`)),o.id&&(e=e.concat("/:id")),e||"/"}function Ue(o){const s=new URL(o).hash.slice(1).split("/")[2];return s.startsWith(":")?s.slice(1):s}function $e(){return location.hash.replace("#","")||"/"}function Oe(){const o=$e(),e=Ne(o);return Re(e)}var $;class Ve{constructor(){u(this,$)}getTemplate(){return`
      <header>
        <div class="header-content">
          <a href="/" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Stories
          </a>
          <div id="userInfo"></div>
        </div>
      </header>

      <main id="asep">
        <div id="loading" class="loading">Loading story details...</div>
        <div id="error" class="error-message" style="display: none;"></div>

        <section id="storyContainer" class="story-container" style="display: none;">
          <img id="storyImage" class="story-image" src="" alt="Story Image">
          <div class="story-content">
            <div class="story-header">
              <h1 id="storyTitle" class="story-title"></h1>
              <div id="storyDate" class="story-date"></div>
            </div>
            <p id="storyDescription" class="story-description"></p>
            <div id="storyLocation" class="story-location" style="display: none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              <span id="locationText"></span>
            </div>
            <div id="mapContainer" class="map-container" style="display: none;"></div>
          </div>
        </section>
      </main>
    `}getElements(){return{loadingElement:document.getElementById("loading"),errorElement:document.getElementById("error"),storyContainer:document.getElementById("storyContainer"),storyImage:document.getElementById("storyImage"),storyTitle:document.getElementById("storyTitle"),storyDate:document.getElementById("storyDate"),storyDescription:document.getElementById("storyDescription"),storyLocation:document.getElementById("storyLocation"),locationText:document.getElementById("locationText"),mapContainer:document.getElementById("mapContainer"),userInfo:document.getElementById("userInfo"),backButton:document.querySelector(".back-button")}}bindBackButton(e){const{backButton:t}=this.getElements();t&&t.addEventListener("click",e)}showLoading(){const{loadingElement:e,errorElement:t,storyContainer:s}=this.getElements();e&&(e.style.display="block"),t&&(t.style.display="none"),s&&(s.style.display="none")}hideLoading(){const{loadingElement:e}=this.getElements();e&&(e.style.display="none")}showError(e){const{errorElement:t,storyContainer:s}=this.getElements();t&&(t.textContent=e,t.style.display="block"),s&&(s.style.display="none")}displayStory(e){const{storyImage:t,storyTitle:s,storyDescription:n,storyDate:i,storyLocation:a,locationText:c,mapContainer:l,userInfo:m,storyContainer:w}=this.getElements();t&&(t.src=e.photoUrl,t.alt=`${e.name}'s story`),s&&(s.textContent=e.name),n&&(n.textContent=e.description);const b=new Date(e.createdAt);i&&(i.textContent=b.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})),e.lat&&e.lon?(a&&(a.style.display="flex"),c&&(c.textContent=`Lat: ${e.lat.toFixed(4)}, Lon: ${e.lon.toFixed(4)}`),this.initializeMap(e.lat,e.lon)):(a&&(a.style.display="none"),l&&(l.style.display="none"));const se=localStorage.getItem("userName");se&&m&&(m.textContent=`Hello, ${se}`),w&&(w.style.display="block")}initializeMap(e,t){const{mapContainer:s}=this.getElements();if(!s||!window.L){console.warn("Leaflet or container missing.");return}s.style.display="block",s.innerHTML='<div id="map" style="height: 400px; width: 100%; position: relative;"></div>';const n=[e,t],i=L.map("map",{center:n,zoom:15,zoomControl:!1});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',minZoom:5,maxZoom:18}).addTo(i),L.marker(i.getCenter()).addTo(i).bindPopup(`Location of the story:<br>Lat: ${e.toFixed(4)}<br>Lon: ${t.toFixed(4)}`).openPopup(),setTimeout(()=>{i.invalidateSize(),i.setView(n)},200);const c=L.popup();i.on("click",l=>{c.setLatLng(l.latlng).setContent(`You clicked at Lat: ${l.latlng.lat.toFixed(4)}, Lon: ${l.latlng.lng.toFixed(4)}`).openOn(i)})}async render(){return this.getTemplate()}async afterRender(){const e=new Fe,t=v,s=Ue;h(this,$,new Ae({view:this,detailStoryModel:e,authModel:t,urlParser:s})),await r(this,$).initialize()}}$=new WeakMap;var f,D,O;class je{constructor({view:e,authModel:t,sleepFunction:s}){u(this,f);u(this,D);u(this,O);h(this,f,e),h(this,D,t),h(this,O,s)}async initialize(){r(this,f).bindLoginFormSubmit(this._handleLoginSubmit.bind(this)),localStorage.getItem("authToken")&&(window.location.hash="#/")}async _handleLoginSubmit(e){e.preventDefault(),r(this,f).hideMessages();const{email:t,password:s}=r(this,f).getLoginFormValues();try{const n=await r(this,D).login(t,s);n.success?(r(this,D).constructor.storeAuthData(n.data.token,n.data.userId,n.data.name),r(this,f).displayMessage(n.data.message,"success"),await r(this,O).call(this,5e3),r(this,f).displayMessage("Login successful! Redirecting to home page...","success"),window.location.hash="#/"):r(this,f).displayMessage(n.error||"Login failed. Please try again.","error")}catch(n){r(this,f).displayMessage("An error occurred. Please check your connection and try again.","error"),console.error("Error:",n)}}}f=new WeakMap,D=new WeakMap,O=new WeakMap;function he(o=1e3){return new Promise(e=>setTimeout(e,o))}var V;class ze{constructor(){u(this,V)}getTemplate(){return`
      <main class="container">
        <h1>Login to Your Account</h1>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
          </div>
          <button type="submit">Login</button>
        </form>
        <section style="margin-top: 16px; text-align: center;">
          <span>Belum punya akun? </span>
          <a href="#/register" id="register-link">Daftar di sini</a>
        </section>
        <section id="message" class="message"></section>
        <section id="userInfo" class="user-info" style="display:none;">
          <h3>Login Successful</h3>
          <p><strong>User ID:</strong> <span id="userId"></span></p>
          <p><strong>Name:</strong> <span id="userName"></span></p>
          <p><strong>Token:</strong></p>
          <p class="token" id="userToken"></p>
        </section>
      </main>
    `}getElements(){return{loginForm:document.getElementById("loginForm"),messageDiv:document.getElementById("message"),userInfoDiv:document.getElementById("userInfo"),emailInput:document.getElementById("email"),passwordInput:document.getElementById("password")}}bindLoginFormSubmit(e){const{loginForm:t}=this.getElements();t&&t.addEventListener("submit",e)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessages(){const{messageDiv:e,userInfoDiv:t}=this.getElements();e&&(e.style.display="none"),t&&(t.style.display="none")}getLoginFormValues(){const{emailInput:e,passwordInput:t}=this.getElements();return{email:e.value,password:t.value}}async render(){return this.getTemplate()}async afterRender(){const e=new v,t=he;h(this,V,new je({view:this,authModel:e,sleepFunction:t})),await r(this,V).initialize()}}V=new WeakMap;var g,E,_,T;class Ge{constructor({view:e,registerModel:t,loginModel:s,sleepFunction:n}){u(this,g);u(this,E);u(this,_);u(this,T);h(this,g,e),h(this,E,t),h(this,_,s),h(this,T,n)}async initialize(){r(this,g).bindRegisterFormSubmit(this._handleRegistrationSubmit.bind(this)),r(this,g).bindGuestButtonClick(this._handleGuestAccountCreation.bind(this))}async _handleRegistrationSubmit(e){e.preventDefault(),r(this,g).hideMessage();const{name:t,email:s,password:n}=r(this,g).getRegistrationFormValues(),i=r(this,E).isValidEmail(s),a=r(this,E).isValidPassword(n);if(!i){r(this,g).displayMessage("Invalid email format.","error");return}if(!a){r(this,g).displayMessage("Password must be at least 8 characters.","error");return}try{const c=await new(r(this,E))().register({name:t,email:s,password:n});if(console.log("Result presenter:",c),c.success)r(this,g).displayMessage("Registration successful! Please check your email to verify your account.","success"),r(this,g).resetRegistrationForm(),await r(this,T).call(this,500),window.location.href="#/login";else{r(this,g).displayMessage(c.error||"Registration failed. Please try again.","error");return}}catch(c){r(this,g).displayMessage("An error occurred. Please check your connection and try again.","error"),console.error("Error:",c)}}async _handleGuestAccountCreation(){try{const e=`Guest_${Math.random().toString(36).substring(2,8)}`,t=`${e.toLowerCase()}.${Math.random().toString(36).substring(2,8)}@gmail.com`,s=Math.random().toString(36).substring(2,10);if((await new(r(this,E))().register({name:e,email:t,password:s})).success){r(this,g).displayMessage("Guest account created successfully!","success"),localStorage.setItem("guestSession",JSON.stringify({email:t,password:s}));const i=JSON.parse(localStorage.getItem("guestSession")),a=await new(r(this,_))().login(i.email,i.password);a.success?(r(this,_).storeAuthData(a.data.token,a.data.userId,a.data.name),await r(this,T).call(this,2e3),window.location.href="/"):r(this,g).displayMessage("Failed to log in with guest account.","error")}else{r(this,g).displayMessage("Failed to create guest account. Please try again.","error");return}}catch(e){r(this,g).displayMessage("Error creating guest account.","error"),console.error("Guest account error:",e)}}}g=new WeakMap,E=new WeakMap,_=new WeakMap,T=new WeakMap;class We{constructor(e=H.REGISTER||"https://story-api.dicoding.dev/v1/register"){this.baseUrl=e}async register({name:e,email:t,password:s}){try{const n={name:e,email:t,password:s};console.log("Request payload:",n);const i=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),a=await i.text();console.log("Raw response:",a);const c=a?JSON.parse(a):{};if(console.log("Data response:",c),i.ok)return{success:!0,data:c,error:null};throw new Error(c.message||"Registration failed")}catch(n){return{success:!1,data:null,error:n.message}}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static isValidPassword(e){return e.length>=8}}var j;class He{constructor(){u(this,j)}getTemplate(){return`
      <main class="container">
        <h1>Register Account</h1>
        <form id="registrationForm">
          <div class="form-group">
            <label for="username">Full Name</label>
            <input type="text" id="username" name="username" required />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required minlength="8" />
            <div class="password-hint">Password must be at least 8 characters</div>
          </div>
          <button type="submit">Register</button>
          <button type="button" id="guestButton" class="guest-button">Continue as Guest</button>
        </form>
        <section id="message" class="message"></section>
      </main>
    `}getElements(){return{registrationForm:document.getElementById("registrationForm"),guestButton:document.getElementById("guestButton"),messageDiv:document.getElementById("message"),usernameInput:document.getElementById("username"),emailInput:document.getElementById("email"),passwordInput:document.getElementById("password")}}bindRegisterFormSubmit(e){const{registrationForm:t}=this.getElements();t&&t.addEventListener("submit",e)}bindGuestButtonClick(e){const{guestButton:t}=this.getElements();t&&t.addEventListener("click",e)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessage(){const{messageDiv:e}=this.getElements();e&&(e.style.display="none")}getRegistrationFormValues(){const{usernameInput:e,emailInput:t,passwordInput:s}=this.getElements();return{name:e.value,email:t.value,password:s.value}}resetRegistrationForm(){const{registrationForm:e}=this.getElements();e&&e.reset()}async render(){return this.getTemplate()}async afterRender(){const e=We,t=v,s=he;h(this,j,new Ge({view:this,registerModel:e,loginModel:t,sleepFunction:s})),await r(this,j).initialize()}}j=new WeakMap;const Y={"/":new De,"/detail/:id":new Ve,"/login":new ze,"/register":new He,"/add":new xe};class qe{constructor({content:e}){this._content=e}async renderPage(){const e=localStorage.getItem("authToken");let t=Oe();console.log(t),(!t||!Y[t])&&(t="/login",window.location.hash="/login"),!e&&t!=="/register"&&(t="/login",window.location.hash="/login"),e&&t==="/login"&&(t="/",window.location.hash="/");const s=Y[t]||Y["/login"];if(!s){document.startViewTransition?document.startViewTransition(async()=>{this._content.innerHTML="<h2>404 - Halaman tidak ditemukan</h2>"}):this._content.innerHTML="<h2>404 - Halaman tidak ditemukan</h2>";return}document.startViewTransition?document.startViewTransition(async()=>{this._content.innerHTML=await s.render(),await s.afterRender()}):(this._content.innerHTML=await s.render(),await s.afterRender())}showNotificationPermissionPrompt(){return Notification.requestPermission()}showNotificationSupportWarning(){console.warn("Notifications not supported in this browser.")}showNotificationPermissionDeniedWarning(){console.warn("Notification permission denied.")}}const Ke="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function Je(o){const e="=".repeat((4-o.length%4)%4),t=(o+e).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),n=new Uint8Array(s.length);for(let i=0;i<s.length;++i)n[i]=s.charCodeAt(i);return n}class Ye{constructor(){this._vapidPublicKey=Ke}_getToken(){const e=localStorage.getItem("authToken");return e||(console.log("Silahkan login dulu"),window.location.hash="/login"),e}async subscribeUserToPush(){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw new Error("Service Worker or Push API not supported");try{const e=await navigator.serviceWorker.ready,t=Je(this._vapidPublicKey),s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t});return console.log("Push Subscription:",s),await this._sendSubscriptionToBackend(s)}catch(e){throw console.error("Failed to subscribe the user: ",e),e}}async _sendSubscriptionToBackend(e){const t=this._getToken();if(!t){console.error("No auth token found");return}const s="https://story-api.dicoding.dev/v1/notifications/subscribe";console.log("Preparing subscription data for backend...");const n=e.getKey("p256dh"),i=e.getKey("auth");if(!n||!i)throw console.error("Subscription keys are missing"),new Error("Subscription keys are missing");const a={endpoint:e.endpoint,keys:{p256dh:btoa(String.fromCharCode(...new Uint8Array(n))),auth:btoa(String.fromCharCode(...new Uint8Array(i)))}};console.log("Sending subscription to backend:",a);try{const c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(a)}),l=await c.json();if(!c.ok)throw console.error("Backend subscription error:",l),new Error(l.message||"Failed to send subscription to backend");return console.log("Backend subscription successful:",l),l}catch(c){throw console.error("Subscription error:",c),c}}async unsubscribeUserFromPush(){if(!("serviceWorker"in navigator))throw new Error("Service Worker not supported");try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(t){const s=t.endpoint;if(await t.unsubscribe())return console.log("User unsubscribed successfully."),await this._sendUnsubscriptionToBackend(s);throw new Error("Failed to unsubscribe the user from browser.")}else return console.log("No active push subscription found."),null}catch(e){throw console.error("Failed to unsubscribe the user: ",e),e}}async _sendUnsubscriptionToBackend(e){const t=this._getToken();if(!t)return;const s="https://story-api.dicoding.dev/v1/notifications/subscribe",n={endpoint:e};try{const i=await fetch(s,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(n)}),a=await i.json();if(!i.ok)throw new Error(a.message||"Failed to send unsubscription to backend");return console.log("Unsubscription sent to backend successfully:",a),a}catch(i){throw console.error("Error sending unsubscription to backend:",i),i}}}var S,B;class Ze{constructor({view:e,notificationModel:t}){u(this,S);u(this,B);h(this,S,e),h(this,B,t)}async initializeNotifications(){if("Notification"in window)try{console.log("Requesting notification permission...");const e=await r(this,S).showNotificationPermissionPrompt();if(e==="granted"){console.log("Permission granted, checking existing subscription...");const s=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(s){console.log("Existing subscription found:",s);try{await r(this,B).unsubscribeUserFromPush(),console.log("Successfully unsubscribed from previous subscription")}catch(i){console.warn("Unsubscription error:",i)}}console.log("Attempting to subscribe...");const n=await r(this,B).subscribeUserToPush();console.log("New subscription created:",n)}else console.log("Permission denied:",e),r(this,S).showNotificationPermissionDeniedWarning()}catch(e){console.error("Notification initialization error:",e)}else console.log("Notifications not supported"),r(this,S).showNotificationSupportWarning()}async handleUnsubscribeClick(){try{await r(this,B).unsubscribeUserFromPush()}catch(e){console.error("Error during unsubscription:",e)}}async checkSubscriptionStatus(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch(e){console.error("Error checking subscription status:",e)}}}S=new WeakMap,B=new WeakMap;document.addEventListener("DOMContentLoaded",async()=>{const o=new qe({content:document.querySelector("#main-content")}),e=new Ye;await new Ze({view:o,notificationModel:e}).initializeNotifications(),await o.renderPage(),window.addEventListener("hashchange",async()=>{await o.renderPage()})});
