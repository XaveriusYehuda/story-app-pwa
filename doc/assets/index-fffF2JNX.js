var H=r=>{throw TypeError(r)};var q=(r,e,t)=>e.has(r)||H("Cannot "+t);var o=(r,e,t)=>(q(r,e,"read from private field"),t?t.call(r):e.get(r)),d=(r,e,t)=>e.has(r)?H("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),u=(r,e,t,s)=>(q(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const K=r=>`
  <article class="story-item">
    <img src="${r.photoUrl}" alt="${r.description}" class="story-item__thumbnail" loading="lazy">
    <div class="story-item__content">
      <h3 class="story-item__name">${r.name}</h3>
      <p class="story-item__description">${r.description}</p>
      <p class="story-item__date">${new Date(r.createdAt).toLocaleDateString()}</p>
      ${r.lat&&r.lon?`
        <button class="story-item__view-on-map" data-lat="${r.lat}" data-lon="${r.lon}" onclick="window.location.hash = '#/detail/:${r.id}'">Lihat di Peta</button>
      `:""}
    </div>
  </article>
`;var p,_,T;class Y{constructor({view:e,storyModel:t,authModel:s}){d(this,p);d(this,_);d(this,T);u(this,p,e),u(this,_,t),u(this,T,s)}async initialize(){o(this,p).bindLogoutButton(this._handleLogout.bind(this)),await this._loadStories(),o(this,p).focusMainContent(),o(this,p).handleSkipLinkAutoFocus()}_handleLogout(e){e.preventDefault(),o(this,T).clearAuthData(),window.location.hash="#/login"}async _loadStories(){const e=localStorage.getItem("authToken");if(!e){o(this,p).displayLoginPrompt();return}try{const t=await o(this,_).getAllStories(e,1,10,0);t.success?o(this,p).renderStories(t.data):(console.error("Error fetching stories:",t.error),o(this,p).displayErrorMessage(t.error))}catch(t){console.error("Failed to fetch stories:",t),o(this,p).displayErrorMessage("Terjadi kesalahan saat mengambil data cerita.")}}}p=new WeakMap,_=new WeakMap,T=new WeakMap;const O="https://story-api.dicoding.dev/v1",G={REGISTER:`${O}/register`,LOGIN:`${O}/login`,ADD_STORY:`${O}/stories`,GET_ALL_STORIES:`${O}/stories`};class Z{constructor(e=G.GET_ALL_STORIES||"https://story-api.dicoding.dev/v1/stories"){this.baseUrl=e}async getAllStories(e,t=1,s=10,i=0){try{const n=await fetch(`${this.baseUrl}?page=${t}&size=${s}&location=${i}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),a=await n.json();if(!n.ok)throw new Error(a.message||"Failed to fetch stories");return{success:!0,data:a.listStory,error:null,source:"network_or_sw_cache"}}catch(n){return console.error("Error fetching stories:",n),{success:!1,data:null,error:n.message||"An error occurred while fetching stories. Check your internet connection.",source:"fetch_failed"}}}}class v{constructor(e=G.LOGIN){this.baseUrl=e}async _clearServiceWorkerCaches(){return"serviceWorker"in navigator&&navigator.serviceWorker.controller?(console.log("Mengirim pesan ke service worker untuk membersihkan cache..."),new Promise((e,t)=>{const s=new MessageChannel;s.port1.onmessage=i=>{i.data.status==="success"?(console.log("Cache service worker berhasil dikosongkan."),e()):(console.error("Gagal mengosongkan cache service worker:",i.data.error),t(new Error(i.data.error)))},navigator.serviceWorker.controller.postMessage({action:"clearAllCaches"},[s.port2])})):(console.warn("Service Worker tidak terdaftar atau tidak aktif. Tidak dapat membersihkan cache."),Promise.resolve())}async login(e,t){try{const s=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),i=await s.json();if(!s.ok)throw new Error(i.message||"Login failed");return{success:!0,data:{message:i.message,userId:i.loginResult.userId,name:i.loginResult.name,token:i.loginResult.token},error:null}}catch(s){return{success:!1,data:null,error:s.message||"An error occurred during login"}}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static storeAuthData(e,t,s){localStorage.setItem("authToken",e),localStorage.setItem("userId",t),localStorage.setItem("userName",s)}static isAuthenticated(){return!!localStorage.getItem("authToken")}static async clearAuthData(){localStorage.removeItem("authToken"),localStorage.removeItem("userId"),localStorage.removeItem("userName"),await new v()._clearServiceWorkerCaches()}}var F;class Q{constructor(){d(this,F)}getTemplate(){return`
      <a href="#mainContent" class="skip-link">Skip to main content</a>
      <header>
        <div class="header-content">
          <a href="#/login" id="logoutBtn" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Logout
          </a>
          <div id="userInfo"></div>
        </div>
      </header>
      <main id='asep3' tabindex="-1"> <h1>Story List</h1>
        <h2>Bagikan Ceritamu!</h2>
        <p>Temukan cerita menarik dari pengguna Dicoding.</p>
        <a id="tambahBtn" href="#/add">Tambah Cerita</a>
        <div id="story-container"></div>
      </main>
    `}getElements(){return{logoutBtn:document.getElementById("logoutBtn"),storyContainer:document.getElementById("story-container"),userInfoDiv:document.getElementById("userInfo"),mainContent:document.querySelector("#story-container"),skipLink:document.querySelector(".skip-link")}}bindLogoutButton(e){const{logoutBtn:t}=this.getElements();t&&t.addEventListener("click",e)}renderStories(e){const{storyContainer:t}=this.getElements();t&&(t.innerHTML="",e.forEach(s=>{const i=document.createElement("div");i.classList.add("story"),i.innerHTML+=K(s),t.appendChild(i)}))}handleSkipLinkAutoFocus(){const{skipLink:e}=this.getElements();if(!e)return;function t(){window.scrollY===0?(e.style.top="80px",e.style.left="50px",e.tabIndex=0,e.focus()):(e.style.top="-100px",e.tabIndex=-1,e.blur())}window.addEventListener("scroll",t),window.addEventListener("load",t)}displayLoginPrompt(){const{storyContainer:e}=this.getElements();e&&(e.innerHTML='<p>Anda harus <a href="#/login">login</a> terlebih dahulu untuk melihat daftar cerita.</p>')}displayErrorMessage(e){const{storyContainer:t}=this.getElements();t&&(t.innerHTML=`<p>Error: ${e}</p>`)}focusMainContent(){const{mainContent:e,skipLink:t}=this.getElements();!e||!t||t._focusHandlerAdded||(t.addEventListener("click",function(s){s.preventDefault(),t.blur();const i=e.querySelector(".story-item__view-on-map");i?i.focus():e.focus(),e.scrollIntoView()}),t._focusHandlerAdded=!0)}async render(){return this.getTemplate()}async afterRender(){const e=new Z,t=v;u(this,F,new Y({view:this,storyModel:e,authModel:t})),await o(this,F).initialize()}}F=new WeakMap;var l,E,z,P;class X{constructor({view:e,addStoryModel:t,authModel:s=v}){d(this,l);d(this,E);d(this,z);d(this,P);u(this,l,e),u(this,E,t),u(this,z,s),u(this,P,localStorage.getItem("authToken")),this._stream=null,this._map=null,this._marker=null}async initialize(){if(!o(this,P)){o(this,l).displayMessage("You need to login first to share a story","error"),o(this,l).hideForm(),setTimeout(()=>window.location.href="#/login",2e3);return}const{map:e,marker:t}=o(this,l).initMap(this._handleMapClick.bind(this),this._handleLatLonInputChange.bind(this));this._map=e,this._marker=t,o(this,l).bindFormSubmit(this._handleSubmitStory.bind(this)),o(this,l).bindStartCameraButton(this._handleStartCamera.bind(this)),o(this,l).bindCaptureButton(this._handleCapturePhoto.bind(this)),o(this,l).bindPhotoInputChange(this._handlePhotoInputChange.bind(this)),o(this,l).bindLocationInputChanges(()=>this._handleLatLonInputChange(o(this,l).getElements().latInput,o(this,l).getElements().lonInput,this._marker,this._map),()=>this._handleLatLonInputChange(o(this,l).getElements().latInput,o(this,l).getElements().lonInput,this._marker,this._map))}_handleMapClick(e,t,s,i){this._marker=o(this,l).updateMapMarker(e,t,s,i)}_handleLatLonInputChange(e,t,s,i){const n=parseFloat(e.value),a=parseFloat(t.value);isNaN(n)||isNaN(a)||(this._marker=o(this,l).updateMapMarker(n,a,s,i),i&&i.setView([n,a],i.getZoom()))}async _handleStartCamera(){try{this._stream=await navigator.mediaDevices.getUserMedia({video:!0}),o(this,l).showCameraPreview(this._stream)}catch(e){alert("Unable to access camera: "+e.message)}}_handleCapturePhoto(){if(!this._stream)return;const{snapshotCanvas:e,cameraPreview:t,photoInput:s}=o(this,l).getElements(),i=e.getContext("2d");e.width=t.videoWidth,e.height=t.videoHeight,i.drawImage(t,0,0,e.width,e.height),e.toBlob(n=>{const a=new File([n],"captured.jpeg",{type:"image/jpeg"}),c=new DataTransfer;c.items.add(a),s.files=c.files;const m=URL.createObjectURL(a);o(this,l).displayPhotoPreview(m),this._stream&&(this._stream.getTracks().forEach(f=>f.stop()),this._stream=null),o(this,l).hideCameraPreview()},"image/jpeg",.95)}_handlePhotoInputChange(e){const t=e.target.files[0];if(t&&t.type.startsWith("image/")){const s=URL.createObjectURL(t);o(this,l).displayPhotoPreview(s)}}async _handleSubmitStory(e){e.preventDefault(),o(this,l).hideMessage(),o(this,l).disableSubmitButton(!0);const{descriptionInput:t,photoInput:s,latInput:i,lonInput:n}=o(this,l).getElements(),a=s.files[0];if(typeof o(this,E).isValidImage!="function"||!o(this,E).isValidImage(a)){o(this,l).displayMessage("Please upload a valid image (JPEG/PNG/GIF, max 1MB)","error"),o(this,l).disableSubmitButton(!1);return}const c=new FormData;c.append("description",t.value),c.append("photo",a),i.value&&n.value&&(c.append("lat",parseFloat(i.value)),c.append("lon",parseFloat(n.value)));try{const m=await new(o(this,E))().submitStory(c,o(this,P));m.success?(o(this,l).displayMessage("Story submitted successfully!","success"),o(this,l).resetForm(),window.location.href="/"):o(this,l).displayMessage(m.error||"Failed to submit story","error")}catch(m){o(this,l).displayMessage("An error occurred. Please try again.","error"),console.error(m)}finally{o(this,l).disableSubmitButton(!1)}}}l=new WeakMap,E=new WeakMap,z=new WeakMap,P=new WeakMap;class ee{constructor(e=G.ADD_STORY||"https://story-api.dicoding.dev/v1/stories"){this.baseUrl=e}async submitStory(e,t){try{const s=await fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e}),i=await s.text();console.log("Raw response text:",i);const n=JSON.parse(i);if(s.status!==201)throw new Error(n.message||"Failed to submit story");if(s.status===201)return{success:!0,data:n,error:null}}catch(s){return{success:!1,data:null,error:s.message||"An error occurred while submitting the story"}}}static isValidImage(e){if(!e)return!1;const t=["image/jpeg","image/png","image/gif"],s=1*1024*1024;return t.includes(e.type)&&e.size<=s}}var x;class te{constructor(){d(this,x)}getTemplate(){return`
      <header>
        <div class="header-content">
          <a href="/" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Stories
          </a>
          <div id="userInfo"></div>
        </div>
      </header>

      <main id="alien" class="story-container">
        <h1>Share Your Story</h1>
        <form id="storyForm" enctype="multipart/form-data">
          <section class="form-group">
            <label for="description">Story Description</label>
            <textarea id="description" name="description" rows="4" required></textarea>
          </section>

          <section class="form-group">
            <label>Take a Photo or Upload</label>
            <div class="camera-section">
              <video id="cameraPreview" autoplay playsinline style="display: none; width: 100%; max-height: 250px;"></video>
              <button type="button" id="startCameraBtn" class="captureBtn">Start Camera</button>
              <button type="button" id="captureBtn" class="captureBtn">Capture</button>
              <canvas id="snapshotCanvas" style="display: none;"></canvas>
            </div>

            <div id="asep2" class="form-group">
              <label for="photo">Or Upload Photo (Max 1MB)</label>
              <input type="file" id="photo" name="photo" accept="image/*">
              <div class="file-hint">Accepted formats: JPEG, PNG, GIF</div>
              <img id="photo-preview" style="max-width: 100%; margin-top: 10px; display: none;" />
            </div>
          </section>

          <section class="location-group">
            <h3>Location (Optional)</h3>
            <div class="form-row">
              <div class="form-group half-width">
                <label for="lat">Latitude</label>
                <input type="number" id="lat" name="lat" step="any" placeholder="e.g., -6.2088">
              </div>
              <div class="form-group half-width">
                <label for="lon">Longitude</label>
                <input type="number" id="lon" name="lon" step="any" placeholder="e.g., 106.8456">
              </div>
            </div>
            <div class="map-container" style="margin-top: 10px; margin-bottom: 10px; margin-right: 10px; margin-left: 10px;">
              <div id="map-picker"></div>
            </div>
          </section>

          <button type="submit" id="submitBtn">Submit Story</button>
        </form>

        <section id="message" class="message"></section>
      </main>
    `}getElements(){return{storyForm:document.getElementById("storyForm"),descriptionInput:document.getElementById("description"),photoInput:document.getElementById("photo"),latInput:document.getElementById("lat"),lonInput:document.getElementById("lon"),messageDiv:document.getElementById("message"),submitBtn:document.getElementById("submitBtn"),mapPicker:document.getElementById("map-picker"),cameraPreview:document.getElementById("cameraPreview"),startCameraBtn:document.getElementById("startCameraBtn"),captureBtn:document.getElementById("captureBtn"),snapshotCanvas:document.getElementById("snapshotCanvas"),photoPreview:document.getElementById("photo-preview")}}bindFormSubmit(e){const{storyForm:t}=this.getElements();t&&t.addEventListener("submit",e)}bindStartCameraButton(e){const{startCameraBtn:t}=this.getElements();t&&t.addEventListener("click",e)}bindCaptureButton(e){const{captureBtn:t}=this.getElements();t&&t.addEventListener("click",e)}bindPhotoInputChange(e){const{photoInput:t}=this.getElements();t&&t.addEventListener("change",e)}bindLocationInputChanges(e,t){const{latInput:s,lonInput:i}=this.getElements();s&&s.addEventListener("change",e),i&&i.addEventListener("change",t)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessage(){const{messageDiv:e}=this.getElements();e&&(e.style.display="none")}disableSubmitButton(e){const{submitBtn:t}=this.getElements();t&&(t.disabled=e,t.textContent=e?"Submitting...":"Submit Story")}hideForm(){const{storyForm:e}=this.getElements();e&&(e.style.display="none")}showCameraPreview(e){const{cameraPreview:t,captureBtn:s}=this.getElements();t&&(t.srcObject=e,t.style.display=""),s&&(s.disabled=!1)}hideCameraPreview(){const{cameraPreview:e,captureBtn:t}=this.getElements();e&&(e.srcObject=null,e.style.display="none"),t&&(t.disabled=!0)}displayPhotoPreview(e){const{photoPreview:t}=this.getElements();t&&(t.src=e,t.style.display="block")}hidePhotoPreview(){const{photoPreview:e}=this.getElements();e&&(e.src="",e.style.display="none")}resetForm(){const{storyForm:e}=this.getElements();e&&e.reset(),this.hidePhotoPreview(),this.hideCameraPreview()}initMap(e,t){const{mapPicker:s,latInput:i,lonInput:n}=this.getElements();let a,c;if(window.L&&s){s.style.width="100%",s.style.height="400px",s.style.position="relative";const m=[-7.12,110.4225];a=L.map("map-picker",{zoom:12,center:m}),window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',minZoom:5,maxZoom:10}).addTo(a),"geolocation"in navigator||console.error("Geolocation tidak didukung oleh browser ini."),c=L.marker(m),navigator.geolocation.getCurrentPosition(f=>{const{latitude:w,longitude:b}=f.coords;console.log(`Latitude: ${w}, Longitude: ${b}`),a.setView([w,b],15),this.updateMapMarker(w,b,c,a),i.value=w.toFixed(5),n.value=b.toFixed(5)},f=>{console.error("Error getting current position:",f),c.addTo(a),c.bindPopup("Default Location (Semarang)").openPopup()}),a.on("click",f=>{const{lat:w,lng:b}=f.latlng;i.value=w.toFixed(5),n.value=b.toFixed(5),e(w,b,c,a)}),t(i,n,c,a)}return{map:a,marker:c}}updateMapMarker(e,t,s,i){const n=[e,t];return s?s.setLatLng(n):s=window.L.marker(n),s.addTo(i),s.bindPopup(`Latitude: ${e}, Longitude: ${t}`).openPopup(),s}async render(){return this.getTemplate()}async afterRender(){u(this,x,new X({view:this,addStoryModel:ee,authModel:v})),await o(this,x).initialize()}}x=new WeakMap;var g,D,V,A;class se{constructor({view:e,detailStoryModel:t,authModel:s=v,urlParser:i}){d(this,g);d(this,D);d(this,V);d(this,A);u(this,g,e),u(this,D,t),u(this,V,s),u(this,A,i)}async initialize(){o(this,g).bindBackButton(this._handleBackButtonClick.bind(this)),await this._loadStoryDetail()}_handleBackButtonClick(e){e.preventDefault(),window.history.back()}async _loadStoryDetail(){const e=window.location.href,t=o(this,A).call(this,e);console.log("DEBUG: Story ID =",t);const s=localStorage.getItem("authToken");if(!s){o(this,g).showError("Please login first"),setTimeout(()=>window.location.href="#/login",2e3);return}o(this,g).showLoading();try{const i=await o(this,D).getStoryDetail(s,t);setTimeout(()=>{o(this,g).hideLoading(),i.success?o(this,g).displayStory(i.data):o(this,g).showError(i.error||"Failed to load story details.")},500)}catch(i){console.error("Error fetching story detail:",i),o(this,g).hideLoading(),o(this,g).showError("An unexpected error occurred while fetching story details.")}}}g=new WeakMap,D=new WeakMap,V=new WeakMap,A=new WeakMap;class ie{constructor(e="https://story-api.dicoding.dev/v1"){this.baseUrl=e}async getStoryDetail(e,t){try{const s=await fetch(`${this.baseUrl}/stories/${t}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),i=await s.json();if(!s.ok)throw new Error(i.message||"Failed to fetch story");return{success:!0,data:i.story,error:null}}catch(s){return{success:!1,data:null,error:s.message||"An error occurred while fetching the story"}}}}function oe(r){const e=r.split("/");return{resource:e[1]||null,id:e[2]||null}}function ne(r){let e="";return r.resource&&(e=e.concat(`/${r.resource}`)),r.id&&(e=e.concat("/:id")),e||"/"}function re(r){const s=new URL(r).hash.slice(1).split("/")[2];return s.startsWith(":")?s.slice(1):s}function ae(){return location.hash.replace("#","")||"/"}function le(){const r=ae(),e=oe(r);return ne(e)}var R;class ce{constructor(){d(this,R)}getTemplate(){return`
      <header>
        <div class="header-content">
          <a href="/" class="back-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Stories
          </a>
          <div id="userInfo"></div>
        </div>
      </header>

      <main id="asep">
        <div id="loading" class="loading">Loading story details...</div>
        <div id="error" class="error-message" style="display: none;"></div>

        <section id="storyContainer" class="story-container" style="display: none;">
          <img id="storyImage" class="story-image" src="" alt="Story Image">
          <div class="story-content">
            <div class="story-header">
              <h1 id="storyTitle" class="story-title"></h1>
              <div id="storyDate" class="story-date"></div>
            </div>
            <p id="storyDescription" class="story-description"></p>
            <div id="storyLocation" class="story-location" style="display: none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              <span id="locationText"></span>
            </div>
            <div id="mapContainer" class="map-container" style="display: none;"></div>
          </div>
        </section>
      </main>
    `}getElements(){return{loadingElement:document.getElementById("loading"),errorElement:document.getElementById("error"),storyContainer:document.getElementById("storyContainer"),storyImage:document.getElementById("storyImage"),storyTitle:document.getElementById("storyTitle"),storyDate:document.getElementById("storyDate"),storyDescription:document.getElementById("storyDescription"),storyLocation:document.getElementById("storyLocation"),locationText:document.getElementById("locationText"),mapContainer:document.getElementById("mapContainer"),userInfo:document.getElementById("userInfo"),backButton:document.querySelector(".back-button")}}bindBackButton(e){const{backButton:t}=this.getElements();t&&t.addEventListener("click",e)}showLoading(){const{loadingElement:e,errorElement:t,storyContainer:s}=this.getElements();e&&(e.style.display="block"),t&&(t.style.display="none"),s&&(s.style.display="none")}hideLoading(){const{loadingElement:e}=this.getElements();e&&(e.style.display="none")}showError(e){const{errorElement:t,storyContainer:s}=this.getElements();t&&(t.textContent=e,t.style.display="block"),s&&(s.style.display="none")}displayStory(e){const{storyImage:t,storyTitle:s,storyDescription:i,storyDate:n,storyLocation:a,locationText:c,mapContainer:m,userInfo:f,storyContainer:w}=this.getElements();t&&(t.src=e.photoUrl,t.alt=`${e.name}'s story`),s&&(s.textContent=e.name),i&&(i.textContent=e.description);const b=new Date(e.createdAt);n&&(n.textContent=b.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})),e.lat&&e.lon?(a&&(a.style.display="flex"),c&&(c.textContent=`Lat: ${e.lat.toFixed(4)}, Lon: ${e.lon.toFixed(4)}`),this.initializeMap(e.lat,e.lon)):(a&&(a.style.display="none"),m&&(m.style.display="none"));const W=localStorage.getItem("userName");W&&f&&(f.textContent=`Hello, ${W}`),w&&(w.style.display="block")}initializeMap(e,t){const{mapContainer:s}=this.getElements();if(!s||!window.L){console.warn("Leaflet or container missing.");return}s.style.display="block",s.innerHTML='<div id="map" style="height: 400px; width: 100%; position: relative;"></div>';const i=[e,t],n=L.map("map",{center:i,zoom:15,zoomControl:!1});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',minZoom:5,maxZoom:18}).addTo(n),L.marker(n.getCenter()).addTo(n).bindPopup(`Location of the story:<br>Lat: ${e.toFixed(4)}<br>Lon: ${t.toFixed(4)}`).openPopup(),setTimeout(()=>{n.invalidateSize(),n.setView(i)},200);const c=L.popup();n.on("click",m=>{c.setLatLng(m.latlng).setContent(`You clicked at Lat: ${m.latlng.lat.toFixed(4)}, Lon: ${m.latlng.lng.toFixed(4)}`).openOn(n)})}async render(){return this.getTemplate()}async afterRender(){const e=new ie,t=v,s=re;u(this,R,new se({view:this,detailStoryModel:e,authModel:t,urlParser:s})),await o(this,R).initialize()}}R=new WeakMap;var y,M,U;class de{constructor({view:e,authModel:t,sleepFunction:s}){d(this,y);d(this,M);d(this,U);u(this,y,e),u(this,M,t),u(this,U,s)}async initialize(){o(this,y).bindLoginFormSubmit(this._handleLoginSubmit.bind(this)),localStorage.getItem("authToken")&&(window.location.hash="/")}async _handleLoginSubmit(e){e.preventDefault(),o(this,y).hideMessages();const{email:t,password:s}=o(this,y).getLoginFormValues();try{const i=await o(this,M).login(t,s);i.success?(o(this,M).constructor.storeAuthData(i.data.token,i.data.userId,i.data.name),o(this,y).displayMessage(i.data.message,"success"),await o(this,U).call(this,5e3),o(this,y).displayMessage("Login successful! Redirecting to home page...","success"),window.location.hash="/"):o(this,y).displayMessage(i.error||"Login failed. Please try again.","error")}catch(i){o(this,y).displayMessage("An error occurred. Please check your connection and try again.","error"),console.error("Error:",i)}}}y=new WeakMap,M=new WeakMap,U=new WeakMap;function J(r=1e3){return new Promise(e=>setTimeout(e,r))}var N;class ue{constructor(){d(this,N)}getTemplate(){return`
      <main class="container">
        <h1>Login to Your Account</h1>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
          </div>
          <button type="submit">Login</button>
        </form>
        <section style="margin-top: 16px; text-align: center;">
          <span>Belum punya akun? </span>
          <a href="#/register" id="register-link">Daftar di sini</a>
        </section>
        <section id="message" class="message"></section>
        <section id="userInfo" class="user-info" style="display:none;">
          <h3>Login Successful</h3>
          <p><strong>User ID:</strong> <span id="userId"></span></p>
          <p><strong>Name:</strong> <span id="userName"></span></p>
          <p><strong>Token:</strong></p>
          <p class="token" id="userToken"></p>
        </section>
      </main>
    `}getElements(){return{loginForm:document.getElementById("loginForm"),messageDiv:document.getElementById("message"),userInfoDiv:document.getElementById("userInfo"),emailInput:document.getElementById("email"),passwordInput:document.getElementById("password")}}bindLoginFormSubmit(e){const{loginForm:t}=this.getElements();t&&t.addEventListener("submit",e)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessages(){const{messageDiv:e,userInfoDiv:t}=this.getElements();e&&(e.style.display="none"),t&&(t.style.display="none")}getLoginFormValues(){const{emailInput:e,passwordInput:t}=this.getElements();return{email:e.value,password:t.value}}async render(){return this.getTemplate()}async afterRender(){const e=new v,t=J;u(this,N,new de({view:this,authModel:e,sleepFunction:t})),await o(this,N).initialize()}}N=new WeakMap;var h,k,B,C;class he{constructor({view:e,registerModel:t,loginModel:s,sleepFunction:i}){d(this,h);d(this,k);d(this,B);d(this,C);u(this,h,e),u(this,k,t),u(this,B,s),u(this,C,i)}async initialize(){o(this,h).bindRegisterFormSubmit(this._handleRegistrationSubmit.bind(this)),o(this,h).bindGuestButtonClick(this._handleGuestAccountCreation.bind(this))}async _handleRegistrationSubmit(e){e.preventDefault(),o(this,h).hideMessage();const{name:t,email:s,password:i}=o(this,h).getRegistrationFormValues(),n=o(this,k).isValidEmail(s),a=o(this,k).isValidPassword(i);if(!n){o(this,h).displayMessage("Invalid email format.","error");return}if(!a){o(this,h).displayMessage("Password must be at least 8 characters.","error");return}try{const c=await new(o(this,k))().register({name:t,email:s,password:i});if(console.log("Result presenter:",c),c.success)o(this,h).displayMessage("Registration successful! Please check your email to verify your account.","success"),o(this,h).resetRegistrationForm(),await o(this,C).call(this,500),window.location.href="#/login";else{o(this,h).displayMessage(c.error||"Registration failed. Please try again.","error");return}}catch(c){o(this,h).displayMessage("An error occurred. Please check your connection and try again.","error"),console.error("Error:",c)}}async _handleGuestAccountCreation(){try{const e=`Guest_${Math.random().toString(36).substring(2,8)}`,t=`${e.toLowerCase()}.${Math.random().toString(36).substring(2,8)}@gmail.com`,s=Math.random().toString(36).substring(2,10);if((await new(o(this,k))().register({name:e,email:t,password:s})).success){o(this,h).displayMessage("Guest account created successfully!","success"),localStorage.setItem("guestSession",JSON.stringify({email:t,password:s}));const n=JSON.parse(localStorage.getItem("guestSession")),a=await new(o(this,B))().login(n.email,n.password);a.success?(o(this,B).storeAuthData(a.data.token,a.data.userId,a.data.name),await o(this,C).call(this,2e3),window.location.href="/"):o(this,h).displayMessage("Failed to log in with guest account.","error")}else{o(this,h).displayMessage("Failed to create guest account. Please try again.","error");return}}catch(e){o(this,h).displayMessage("Error creating guest account.","error"),console.error("Guest account error:",e)}}}h=new WeakMap,k=new WeakMap,B=new WeakMap,C=new WeakMap;class me{constructor(e=G.REGISTER||"https://story-api.dicoding.dev/v1/register"){this.baseUrl=e}async register({name:e,email:t,password:s}){try{const i={name:e,email:t,password:s};console.log("Request payload:",i);const n=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),a=await n.text();console.log("Raw response:",a);const c=a?JSON.parse(a):{};if(console.log("Data response:",c),n.ok)return{success:!0,data:c,error:null};throw new Error(c.message||"Registration failed")}catch(i){return{success:!1,data:null,error:i.message}}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static isValidPassword(e){return e.length>=8}}var $;class ge{constructor(){d(this,$)}getTemplate(){return`
      <main class="container">
        <h1>Register Account</h1>
        <form id="registrationForm">
          <div class="form-group">
            <label for="username">Full Name</label>
            <input type="text" id="username" name="username" required />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required minlength="8" />
            <div class="password-hint">Password must be at least 8 characters</div>
          </div>
          <button type="submit">Register</button>
          <button type="button" id="guestButton" class="guest-button">Continue as Guest</button>
        </form>
        <section id="message" class="message"></section>
      </main>
    `}getElements(){return{registrationForm:document.getElementById("registrationForm"),guestButton:document.getElementById("guestButton"),messageDiv:document.getElementById("message"),usernameInput:document.getElementById("username"),emailInput:document.getElementById("email"),passwordInput:document.getElementById("password")}}bindRegisterFormSubmit(e){const{registrationForm:t}=this.getElements();t&&t.addEventListener("submit",e)}bindGuestButtonClick(e){const{guestButton:t}=this.getElements();t&&t.addEventListener("click",e)}displayMessage(e,t){const{messageDiv:s}=this.getElements();s&&(s.textContent=e,s.className=`message ${t}`,s.style.display="block")}hideMessage(){const{messageDiv:e}=this.getElements();e&&(e.style.display="none")}getRegistrationFormValues(){const{usernameInput:e,emailInput:t,passwordInput:s}=this.getElements();return{name:e.value,email:t.value,password:s.value}}resetRegistrationForm(){const{registrationForm:e}=this.getElements();e&&e.reset()}async render(){return this.getTemplate()}async afterRender(){const e=me,t=v,s=J;u(this,$,new he({view:this,registerModel:e,loginModel:t,sleepFunction:s})),await o(this,$).initialize()}}$=new WeakMap;const j={"/":new Q,"/detail/:id":new ce,"/login":new ue,"/register":new ge,"/add":new te};class pe{constructor({content:e}){this._content=e}async renderPage(){const e=localStorage.getItem("authToken");let t=le();console.log(t),(!t||!j[t])&&(t="/login",window.location.hash="/login"),!e&&t!=="/register"&&(t="/login",window.location.hash="/login"),e&&t==="/login"&&(t="/",window.location.hash="/");const s=j[t]||j["/login"];if(!s){document.startViewTransition?document.startViewTransition(async()=>{this._content.innerHTML="<h2>404 - Halaman tidak ditemukan</h2>"}):this._content.innerHTML="<h2>404 - Halaman tidak ditemukan</h2>";return}document.startViewTransition?document.startViewTransition(async()=>{this._content.innerHTML=await s.render(),await s.afterRender()}):(this._content.innerHTML=await s.render(),await s.afterRender())}showNotificationPermissionPrompt(){return Notification.requestPermission()}showNotificationSupportWarning(){console.warn("Notifications not supported in this browser.")}showNotificationPermissionDeniedWarning(){console.warn("Notification permission denied.")}}const ye="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlfPoJJqxbk";function fe(r){const e="=".repeat((4-r.length%4)%4),t=(r+e).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),i=new Uint8Array(s.length);for(let n=0;n<s.length;++n)i[n]=s.charCodeAt(n);return i}class we{constructor(){this._vapidPublicKey=ye}_getToken(){const e=localStorage.getItem("authToken");return e||(console.log("Silahkan login dulu"),window.location.hash="/login"),e}async subscribeUserToPush(){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw new Error("Service Worker or Push API not supported");try{const e=await navigator.serviceWorker.ready,t=fe(this._vapidPublicKey),s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t});return console.log("Push Subscription:",s),await this._sendSubscriptionToBackend(s)}catch(e){throw console.error("Failed to subscribe the user: ",e),e}}async _sendSubscriptionToBackend(e){const t=this._getToken();if(!t)return;const s="https://story-api.dicoding.dev/v1/notifications/subscribe",i={endpoint:e.endpoint,keys:{p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("auth"))))}};try{const n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)}),a=await n.json();if(!n.ok)throw new Error(a.message||"Failed to send subscription to backend");return console.log("Subscription sent to backend successfully:",a),a}catch(n){throw console.error("Error sending subscription to backend:",n),n}}async unsubscribeUserFromPush(){if(!("serviceWorker"in navigator))throw new Error("Service Worker not supported");try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(t){const s=t.endpoint;if(await t.unsubscribe())return console.log("User unsubscribed successfully."),await this._sendUnsubscriptionToBackend(s);throw new Error("Failed to unsubscribe the user from browser.")}else return console.log("No active push subscription found."),null}catch(e){throw console.error("Failed to unsubscribe the user: ",e),e}}async _sendUnsubscriptionToBackend(e){const t=this._getToken();if(!t)return;const s="https://story-api.dicoding.dev/v1/notifications/subscribe",i={endpoint:e};try{const n=await fetch(s,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)}),a=await n.json();if(!n.ok)throw new Error(a.message||"Failed to send unsubscription to backend");return console.log("Unsubscription sent to backend successfully:",a),a}catch(n){throw console.error("Error sending unsubscription to backend:",n),n}}}var S,I;class be{constructor({view:e,notificationModel:t}){d(this,S);d(this,I);u(this,S,e),u(this,I,t)}async initializeNotifications(){if("Notification"in window)try{if(await o(this,S).showNotificationPermissionPrompt()==="granted"){if(await(await navigator.serviceWorker.ready).pushManager.getSubscription()){console.log("Existing push subscription found. Attempting to clear it for re-subscription.");try{await o(this,I).unsubscribeUserFromPush(),console.log("Previous subscription successfully unsubscribed.")}catch(i){console.warn("Failed to unsubscribe previous subscription, it might not exist on backend or other issue:",i)}}await o(this,I).subscribeUserToPush(),console.log("Successfully subscribed for push notifications.")}else o(this,S).showNotificationPermissionDeniedWarning()}catch(e){console.error("Error during notification initialization:",e)}else o(this,S).showNotificationSupportWarning()}async handleUnsubscribeClick(){try{await o(this,I).unsubscribeUserFromPush()}catch(e){console.error("Error during unsubscription:",e)}}async checkSubscriptionStatus(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch(e){console.error("Error checking subscription status:",e)}}}S=new WeakMap,I=new WeakMap;document.addEventListener("DOMContentLoaded",async()=>{const r=new pe({content:document.querySelector("#main-content")}),e=new we;await new be({view:r,notificationModel:e}).initializeNotifications(),await r.renderPage(),window.addEventListener("hashchange",async()=>{await r.renderPage()})});
